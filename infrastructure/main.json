{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "2.0.0.0",
  "parameters": {
    "location": { "type": "string", "defaultValue": "eastus2" },
    "env": { "type": "string", "allowedValues": ["dev", "staging", "prod"], "defaultValue": "dev" },

    "zones": {
      "type": "array",
      "defaultValue": ["1", "2"],
      "metadata": { "description": "Availability Zones to use in regions that support zones (e.g., eastus2). Keep to 2 zones for simplicity/quota." }
    },

    "vnetAddressPrefix": { "type": "string", "defaultValue": "10.10.0.0/16" },
    "subnetPublicPrefix": { "type": "string", "defaultValue": "10.10.1.0/24" },
    "subnetPrivateAppPrefix": { "type": "string", "defaultValue": "10.10.2.0/24" },
    "subnetPrivateDbPrefix": { "type": "string", "defaultValue": "10.10.3.0/24" },

    "vmAdminUsername": { "type": "string", "defaultValue": "azureuser" },
    "vmAdminPassword": { "type": "secureString" },

    "vmSku": { "type": "string", "defaultValue": "Standard_B2s" },
    "vmInstanceCount": { "type": "int", "defaultValue": 2, "minValue": 2, "maxValue": 4 },

    "sqlAdminUsername": { "type": "string", "defaultValue": "sqladminuser" },
    "sqlAdminPassword": { "type": "secureString" },

    "sqlSkuName": { "type": "string", "defaultValue": "Basic" },
    "sqlMaxSizeBytes": { "type": "string", "defaultValue": "2147483648" },

    "bootstrapScriptUri": {
      "type": "string",
      "metadata": { "description": "Public raw URL to scripts/bootstrap.sh (e.g., GitHub raw). Required." }
    },

    "appHealthPath": { "type": "string", "defaultValue": "/health" },

    "logRetentionDays": { "type": "int", "defaultValue": 30 }
  },
  "variables": {
    "prefix": "[toLower(concat('bbg-', parameters('env'), '-', uniqueString(resourceGroup().id)))]",

    "vnetName": "[concat(variables('prefix'), '-vnet')]",
    "publicSubnetName": "public-subnet",
    "appSubnetName": "private-app-subnet",
    "dbSubnetName": "private-db-subnet",

    "nsgPublicName": "[concat(variables('prefix'), '-nsg-public')]",
    "nsgAppName": "[concat(variables('prefix'), '-nsg-app')]",
    "nsgDbName": "[concat(variables('prefix'), '-nsg-db')]",

    "pipAgwName": "[concat(variables('prefix'), '-pip-agw')]",
    "pipNatName": "[concat(variables('prefix'), '-pip-nat')]",

    "natGwName": "[concat(variables('prefix'), '-natgw')]",
    "agwName": "[concat(variables('prefix'), '-agw')]",
    "vmssName": "[concat(variables('prefix'), '-vmss')]",

    "kvName": "[toLower(replace(concat(variables('prefix'), '-kv'), '-', ''))]",
    "stgName": "[toLower(replace(concat(variables('prefix'), 'stg'), '-', ''))]",

    "sqlServerName": "[toLower(replace(concat(variables('prefix'), '-sql'), '-', ''))]",
    "sqlDbName": "[concat(variables('prefix'), '-db')]",

    "privateDnsZoneNameSql": "privatelink.database.windows.net",
    "peNameSql": "[concat(variables('prefix'), '-sql-pe')]",

    "lawName": "[concat(variables('prefix'), '-law')]",
    "appiName": "[concat(variables('prefix'), '-appi')]",
    "cpuAlertName": "[concat(variables('prefix'), '-cpu-alert')]",

    "dbPasswordSecretName": "sql-admin-password"
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-11-01",
      "name": "[variables('nsgPublicName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "Allow-Internet-To-AppGw-HTTP",
            "properties": {
              "priority": 100,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourceAddressPrefix": "Internet",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "80"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-11-01",
      "name": "[variables('nsgAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "Allow-AppGw-To-App-HTTP",
            "properties": {
              "priority": 100,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourceAddressPrefix": "[parameters('subnetPublicPrefix')]",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "80"
            }
          },
          {
            "name": "Deny-Internet-Inbound",
            "properties": {
              "priority": 200,
              "direction": "Inbound",
              "access": "Deny",
              "protocol": "*",
              "sourceAddressPrefix": "Internet",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-11-01",
      "name": "[variables('nsgDbName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "Allow-App-To-SQL-1433",
            "properties": {
              "priority": 100,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourceAddressPrefix": "[parameters('subnetPrivateAppPrefix')]",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "1433"
            }
          }
        ]
      }
    },

    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-11-01",
      "name": "[variables('pipAgwName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard" },
      "zones": "[parameters('zones')]",
      "properties": {
        "publicIPAllocationMethod": "Static",
        "dnsSettings": { "domainNameLabel": "[concat(variables('prefix'), '-app')]" }
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-11-01",
      "name": "[variables('pipNatName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard" },
      "properties": { "publicIPAllocationMethod": "Static" }
    },
    {
      "type": "Microsoft.Network/natGateways",
      "apiVersion": "2023-11-01",
      "name": "[variables('natGwName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard" },
      "properties": {
        "publicIpAddresses": [
          { "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipNatName'))]" }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipNatName'))]"
      ]
    },

    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2023-11-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": { "addressPrefixes": ["[parameters('vnetAddressPrefix')]"] },
        "subnets": [
          {
            "name": "[variables('publicSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('subnetPublicPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgPublicName'))]"
              }
            }
          },
          {
            "name": "[variables('appSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('subnetPrivateAppPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgAppName'))]"
              },
              "natGateway": {
                "id": "[resourceId('Microsoft.Network/natGateways', variables('natGwName'))]"
              }
            }
          },
          {
            "name": "[variables('dbSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('subnetPrivateDbPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgDbName'))]"
              },
              "privateEndpointNetworkPolicies": "Disabled"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgPublicName'))]",
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgAppName'))]",
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgDbName'))]",
        "[resourceId('Microsoft.Network/natGateways', variables('natGwName'))]"
      ]
    },

    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[variables('stgName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard_LRS" },
      "kind": "StorageV2",
      "properties": {
        "minimumTlsVersion": "TLS1_2",
        "supports
